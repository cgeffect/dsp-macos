# AGC自动增益控制测试指南

## 什么是AGC？

**AGC（Automatic Gain Control，自动增益控制）** 是一种音频信号处理技术，用于自动调节音频信号的增益，使输出音量保持在一个相对稳定的水平。

### AGC的主要功能

1. **自动音量调节** - 根据输入信号的强度自动调整增益
2. **防止过载** - 当输入信号太强时降低增益，防止失真
3. **提升弱信号** - 当输入信号太弱时提高增益，增强可听性
4. **保持稳定音量** - 让输出音量保持在一个相对稳定的水平

### AGC的工作原理

```
输入信号 → 检测信号强度 → 计算所需增益 → 应用增益 → 输出信号
```

- **信号太强** → 降低增益 → 防止过载
- **信号太弱** → 提高增益 → 增强信号
- **信号适中** → 保持增益 → 稳定输出

## 测试配置

### 测试参数
- **采样率**: 16kHz
- **帧大小**: 160样本（10ms）
- **持续时间**: 6秒
- **音频格式**: 16位PCM，单声道

### 测试信号类型

1. **不同振幅正弦波** - 测试AGC对不同音量级别的响应
2. **渐变音量正弦波** - 测试AGC对连续音量变化的响应
3. **不同音量语音** - 测试AGC对真实语音信号的响应

## AGC参数配置

### 参数说明

1. **目标电平** - AGC试图达到的输出电平
   - 较低值：输出音量较小
   - 较高值：输出音量较大

2. **增量** - 音量增加时的增益调整速度
   - 较低值：增益调整较慢，更平滑
   - 较高值：增益调整较快，响应更灵敏

3. **减量** - 音量减少时的增益调整速度
   - 较低值：增益调整较慢，更平滑
   - 较高值：增益调整较快，响应更灵敏

4. **最大增益** - AGC允许的最大增益倍数
   - 限制AGC的最大放大倍数，防止过度放大噪声

### 测试配置

| 配置名称 | 目标电平 | 增量 | 减量 | 最大增益 | 特点 |
|---------|---------|------|------|----------|------|
| 标准AGC | 8000 | 32768 | 32768 | 32768 | 平衡的AGC设置 |
| 强AGC | 4000 | 16384 | 16384 | 16384 | 更强的音量调节 |
| 弱AGC | 12000 | 49152 | 49152 | 49152 | 较弱的音量调节 |
| 快速AGC | 8000 | 16384 | 16384 | 32768 | 快速响应音量变化 |
| 慢速AGC | 8000 | 49152 | 49152 | 32768 | 缓慢响应音量变化 |

## 测试文件说明

### 输入文件

- `agc_variable_sine_input.pcm` - 不同振幅正弦波（1000→3000→8000→15000→500→12000→2000→10000）
- `agc_fade_sine_input.pcm` - 渐变音量正弦波（500→15000）
- `agc_variable_voice_input.pcm` - 不同音量语音信号

### 输出文件

每个AGC配置都会生成对应的输出文件：

- `agc_标准AGC_*.pcm` - 标准AGC处理结果
- `agc_强AGC_*.pcm` - 强AGC处理结果
- `agc_弱AGC_*.pcm` - 弱AGC处理结果
- `agc_快速AGC_*.pcm` - 快速AGC处理结果
- `agc_慢速AGC_*.pcm` - 慢速AGC处理结果

## 测试结果分析

### 预期效果

1. **音量稳定性** - 输出音频的音量应该比输入更稳定
2. **动态范围压缩** - 强信号被压缩，弱信号被增强
3. **响应速度** - 不同配置的响应速度不同

### 分析方法

1. **听觉对比** - 播放输入和输出文件，对比音量变化
2. **RMS分析** - 比较输入和输出的RMS值
3. **峰值分析** - 比较输入和输出的峰值
4. **增益变化** - 计算整体增益变化（dB）

## 使用方法

### 运行测试

```bash
# 编译项目
./build.sh

# 运行AGC测试
./build/agc_test
```

### 播放音频

```bash
# 播放所有测试文件
./play_audio.sh
```

### 单独播放文件

```bash
# 播放原始输入文件
ffplay -f s16le -ar 16000 -ac 1 -nodisp -autoexit agc_variable_sine_input.pcm

# 播放AGC处理后文件
ffplay -f s16le -ar 16000 -ac 1 -nodisp -autoexit agc_标准AGC_variable_sine_output.pcm
```

## 测试建议

### 对比测试

1. **先听原始输入** - 感受音量的大幅变化
2. **再听AGC输出** - 感受音量稳定性
3. **对比不同配置** - 体验不同AGC参数的效果

### 重点关注

1. **音量稳定性** - 输出音量是否更均匀
2. **响应速度** - 快速vs慢速AGC的差异
3. **音质保持** - 是否保持了原始音质
4. **过载保护** - 强信号是否被适当压缩

## 应用场景

### AGC的典型应用

1. **语音通话** - 保持通话音量稳定
2. **录音设备** - 自动调节录音电平
3. **广播系统** - 统一不同节目的音量
4. **会议系统** - 平衡不同发言人的音量
5. **移动设备** - 适应不同环境的声音

### 参数选择建议

- **语音通话**: 标准AGC或快速AGC
- **录音**: 慢速AGC，避免过度调节
- **直播**: 强AGC，确保音量稳定
- **会议**: 标准AGC，平衡响应速度和稳定性

## 技术细节

### SpeexDSP AGC实现

本测试使用SpeexDSP库的预处理器实现AGC功能：

- **算法**: 基于能量检测的自适应增益控制
- **帧处理**: 每10ms处理一帧音频
- **学习期**: 前3帧用于系统学习，不输出
- **实时性**: 支持实时音频处理

### 性能指标

- **延迟**: 约10ms（一帧处理时间）
- **CPU占用**: 较低，适合移动设备
- **内存占用**: 约几KB，非常轻量
- **音质**: 保持原始音质，无明显失真 